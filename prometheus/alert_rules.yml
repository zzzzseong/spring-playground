groups:
  # Spring Boot 애플리케이션 관련 알람
  - name: spring_playground_alerts
    interval: 30s  # 30초마다 규칙 평가
    rules:
      # 1. 애플리케이션이 다운되었을 때
      - alert: ApplicationDown
        expr: up{job="spring-playground"} == 0
        for: 1m  # 1분 동안 지속되면 알람 발생
        labels:
          severity: critical
          service: spring-playground
        annotations:
          summary: "Spring Playground 애플리케이션이 다운되었습니다"
          description: "{{ $labels.instance }}에서 {{ $labels.job }}가 1분 이상 다운 상태입니다."

      # 2. 높은 메모리 사용률
      - alert: HighMemoryUsage
        expr: (jvm_memory_used_bytes{job="spring-playground"} / jvm_memory_max_bytes{job="spring-playground"}) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: spring-playground
        annotations:
          summary: "높은 메모리 사용률 감지"
          description: "메모리 사용률이 80%를 초과했습니다. 현재: {{ $value | humanize }}%"

      # 3. 높은 HTTP 에러율
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_server_requests_seconds_count{job="spring-playground", status=~"5.."}[5m]))
            /
            sum(rate(http_server_requests_seconds_count{job="spring-playground"}[5m]))
          ) * 100 > 5
        for: 5m
        labels:
          severity: warning
          service: spring-playground
        annotations:
          summary: "높은 HTTP 에러율 감지"
          description: "5xx 에러율이 5%를 초과했습니다. 현재: {{ $value | humanize }}%"

      # 4. 높은 응답 시간
      - alert: HighResponseTime
        expr: |
          histogram_quantile(0.95, 
            sum(rate(http_server_requests_seconds_bucket{job="spring-playground"}[5m])) by (le)
          ) > 1
        for: 5m
        labels:
          severity: warning
          service: spring-playground
        annotations:
          summary: "높은 응답 시간 감지"
          description: "95번째 백분위수 응답 시간이 1초를 초과했습니다. 현재: {{ $value }}초"

      # 5. GC 일시정지 시간이 길 때
      - alert: HighGCPauseTime
        expr: |
          sum(rate(jvm_gc_pause_seconds_sum{job="spring-playground"}[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          service: spring-playground
        annotations:
          summary: "높은 GC 일시정지 시간"
          description: "GC 일시정지 시간이 초당 0.1초를 초과했습니다. 현재: {{ $value }}초/초"

      # 6. CPU 사용률이 높을 때
      - alert: HighCPUUsage
        expr: process_cpu_usage{job="spring-playground"} > 0.8
        for: 5m
        labels:
          severity: warning
          service: spring-playground
        annotations:
          summary: "높은 CPU 사용률 감지"
          description: "CPU 사용률이 80%를 초과했습니다. 현재: {{ $value | humanizePercentage }}"

